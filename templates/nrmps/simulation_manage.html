{% extends "base.html" %}
{% block title %}Manage Simulation - NRMP Simulations{% endblock %}
{% block content %}
  <div class="mt-8">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold">Manage: {{ simulation.name }}</h3>
      <div class="flex gap-2">
        <a href="{% url 'nrmps:simulation_list' %}" class="btn btn-outline">Back to List</a>
        <form class="inline" method="post" action="{% url 'nrmps:simulation_delete' pk=simulation.pk %}" x-data
              @submit.prevent="if (confirm('Delete this simulation?')) { $el.submit() }">
          {% csrf_token %}
          <button type="submit" class="btn btn-error btn-outline">Delete Simulation</button>
        </form>
      </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-6">
      <div>
        <form method="post" class="card bg-base-100 shadow-xl">
          {% csrf_token %}
          <input type="hidden" name="form_id" value="simulation">
          <div class="card-header">
            <h2 class="card-title">Edit Simulation</h2>
          </div>
          <div class="card-body">
            <div class="form-control">
              <label class="label" for="id_name"><span class="label-text">Name</span></label>
              {{ form.name }}
            </div>
            <div class="form-control">
              <label class="label" for="id_description"><span class="label-text">Description</span></label>
              {{ form.description }}
            </div>
            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label" for="id_iterations"><span class="label-text">Iterations</span></label>
                {{ form.iterations }}
              </div>
              <div class="form-control">
                <label class="label cursor-pointer">
                  {{ form.public }}
                  <span class="label-text">Public</span>
                </label>
              </div>
            </div>
          </div>
          <div class="card-actions justify-end">
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>

        <form method="post" class="card bg-base-100 shadow-xl mt-6">
          {% csrf_token %}
          <input type="hidden" name="form_id" value="config">
          <div class="card-header">
            <h2 class="card-title">Simulation Configuration</h2>
          </div>
          <div class="card-body">
            {% if config_form.errors %}
              <div class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                  <strong>There are errors in the configuration form:</strong>
                  <ul class="ml-4 list-disc">
                    {% for field, errors in config_form.errors.items %}
                      <li>
                        <span class="capitalize">{{ field|escape }}</span>: {{ errors.as_text|escape }}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            {% endif %}
            {% if config_form.non_field_errors %}
              <div class="alert alert-error">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ config_form.non_field_errors }}</span>
              </div>
            {% endif %}
            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label" for="id_number_of_applicants"><span class="label-text">Number of Applicants</span></label>
                {{ config_form.number_of_applicants }}
                {% if config_form.number_of_applicants.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.number_of_applicants.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_number_of_schools"><span
                    class="label-text">Number of Schools</span></label>
                {{ config_form.number_of_schools }}
                {% if config_form.number_of_schools.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.number_of_schools.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="divider"></div>
            <div class="grid md:grid-cols-3 gap-4">
              <div class="form-control">
                <label class="label" for="id_applicant_score_mean"><span class="label-text">Applicant Score Mean</span></label>
                {{ config_form.applicant_score_mean }}
                {% if config_form.applicant_score_mean.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_score_mean.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_applicant_score_stddev"><span
                    class="label-text">Applicant Score StdDev</span></label>
                {{ config_form.applicant_score_stddev }}
                {% if config_form.applicant_score_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_score_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_applicant_interview_limit"><span class="label-text">Applicant Interview Limit</span></label>
                {{ config_form.applicant_interview_limit }}
                {% if config_form.applicant_interview_limit.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_interview_limit.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="form-control">
                <label class="label" for="id_applicant_meta_preference_stddev"><span class="label-text">Applicant Meta Preference StdDev</span></label>
                {{ config_form.applicant_meta_preference_stddev }}
                {% if config_form.applicant_meta_preference_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_meta_preference_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_applicant_meta_scores_stddev"><span class="label-text">Applicant Meta Scores StdDev</span></label>
                {{ config_form.applicant_meta_scores_stddev }}
                {% if config_form.applicant_meta_scores_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_meta_scores_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="form-control">
                <label class="label" for="id_applicant_pre_interview_rating_error"><span class="label-text">Applicant Pre-interview Rating Error</span></label>
                {{ config_form.applicant_pre_interview_rating_error }}
                {% if config_form.applicant_pre_interview_rating_error.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_pre_interview_rating_error.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_applicant_post_interview_rating_error"><span class="label-text">Applicant Post-interview Rating Error</span></label>
                {{ config_form.applicant_post_interview_rating_error }}
                {% if config_form.applicant_post_interview_rating_error.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.applicant_post_interview_rating_error.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="form-control mt-4"
                 x-data="metaEditor($el, 'id_applicant_meta_preference', {{ config_form.instance.applicant_meta_preference|default:'[]'|safe }})">
              <label class="label" for="id_applicant_meta_preference"><span class="label-text">Applicant Meta Preferences</span></label>
              <div class="flex flex-wrap gap-2 items-center">
                <template x-if="!items.length"><span
                    class="text-base-content/60 text-sm">No items. Add some below.</span></template>
                <template x-for="(item, index) in items" :key="index">
                  <div class="join">
                    <input type="text" class="input input-sm input-bordered join-item" x-model="items[index]"
                           @input="dedupeAndNormalize()" aria-label="meta item">
                    <button type="button" class="btn btn-sm btn-error btn-outline join-item" @click="remove(index)"
                            aria-label="Remove">&times;
                    </button>
                  </div>
                </template>
              </div>
              <div class="flex gap-2 mt-2">
                <input type="text" class="input input-sm input-bordered flex-1" x-model="newItem"
                       @keydown.enter.prevent="addItem()" placeholder="Type a preference (Enter to add)">
                <button type="button" class="btn btn-sm btn-primary btn-outline" @click="addItem()">Add</button>
              </div>
              <input type="hidden" name="applicant_meta_preference" id="id_applicant_meta_preference"
                     :value="jsonValue()"
                     value='{{ config_form.instance.applicant_meta_preference|default:"[]"|safe }}'>
              <label class="label"><span class="label-text-alt">Enter as tags; press Enter to add. Items saved as a list.</span></label>
              {% if config_form.applicant_meta_preference.errors %}
                <label class="label"><span
                    class="label-text-alt text-error">{{ config_form.applicant_meta_preference.errors.0 }}</span></label>
              {% endif %}
            </div>
            <div class="divider"></div>
            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label" for="id_school_score_mean"><span
                    class="label-text">School Score Mean</span></label>
                {{ config_form.school_score_mean }}
                {% if config_form.school_score_mean.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_score_mean.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_school_score_stddev"><span
                    class="label-text">School Score StdDev</span></label>
                {{ config_form.school_score_stddev }}
                {% if config_form.school_score_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_score_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="grid md:grid-cols-3 gap-4 mt-4">
              <div class="form-control">
                <label class="label" for="id_school_capacity_mean"><span class="label-text">Capacity Mean</span></label>
                {{ config_form.school_capacity_mean }}
                {% if config_form.school_capacity_mean.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_capacity_mean.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_school_capacity_stddev"><span
                    class="label-text">Capacity StdDev</span></label>
                {{ config_form.school_capacity_stddev }}
              </div>
              <div class="form-control">
                <label class="label" for="id_school_interview_limit"><span
                    class="label-text">School Interview Limit</span></label>
                {{ config_form.school_interview_limit }}
                {% if config_form.school_interview_limit.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_interview_limit.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="form-control">
                <label class="label" for="id_school_meta_preference_stddev"><span class="label-text">School Meta Preference StdDev</span></label>
                {{ config_form.school_meta_preference_stddev }}
                {% if config_form.school_meta_preference_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_meta_preference_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_school_meta_scores_stddev"><span class="label-text">School Meta Scores StdDev</span></label>
                {{ config_form.school_meta_scores_stddev }}
                {% if config_form.school_meta_scores_stddev.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_meta_scores_stddev.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-4">
              <div class="form-control">
                <label class="label" for="id_school_pre_interview_rating_error"><span class="label-text">School Pre-interview Rating Error</span></label>
                {{ config_form.school_pre_interview_rating_error }}
                {% if config_form.school_pre_interview_rating_error.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_pre_interview_rating_error.errors.0 }}</span></label>
                {% endif %}
              </div>
              <div class="form-control">
                <label class="label" for="id_school_post_interview_rating_error"><span class="label-text">School Post-interview Rating Error</span></label>
                {{ config_form.school_post_interview_rating_error }}
                {% if config_form.school_post_interview_rating_error.errors %}
                  <label class="label"><span
                      class="label-text-alt text-error">{{ config_form.school_post_interview_rating_error.errors.0 }}</span></label>
                {% endif %}
              </div>
            </div>
            <div class="form-control mt-4"
                 x-data="metaEditor($el, 'id_school_meta_preference', {{ config_form.instance.school_meta_preference|default:'[]'|safe }})">
              <label class="label" for="id_school_meta_preference"><span
                  class="label-text">School Meta Preferences</span></label>
              <div class="flex flex-wrap gap-2 items-center">
                <template x-if="!items.length"><span
                    class="text-base-content/60 text-sm">No items. Add some below.</span></template>
                <template x-for="(item, index) in items" :key="index">
                  <div class="join">
                    <input type="text" class="input input-sm input-bordered join-item" x-model="items[index]"
                           @input="dedupeAndNormalize()" aria-label="meta item">
                    <button type="button" class="btn btn-sm btn-error btn-outline join-item" @click="remove(index)"
                            aria-label="Remove">&times;
                    </button>
                  </div>
                </template>
              </div>
              <div class="flex gap-2 mt-2">
                <input type="text" class="input input-sm input-bordered flex-1" x-model="newItem"
                       @keydown.enter.prevent="addItem()" placeholder="Type a preference (Enter to add)">
                <button type="button" class="btn btn-sm btn-primary btn-outline" @click="addItem()">Add</button>
              </div>
              <input type="hidden" name="school_meta_preference" id="id_school_meta_preference" :value="jsonValue()"
                     value='{{ config_form.instance.school_meta_preference|default:"[]"|safe }}'>
              <label class="label"><span class="label-text-alt">Enter as tags; press Enter to add. Items saved as a list.</span></label>
              {% if config_form.school_meta_preference.errors %}
                <label class="label"><span
                    class="label-text-alt text-error">{{ config_form.school_meta_preference.errors.0 }}</span></label>
              {% endif %}
            </div>
          </div>
          <div class="card-actions justify-end">
            <button type="submit" class="btn btn-primary">Save Configuration</button>
          </div>
        </form>
      </div>

      <div>
        {% include "nrmps/partials/_population_counts.html" %}
        <div class="mt-6">
          {% include "nrmps/partials/_interview_counts.html" %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block extra_js %}
  <script>
      window.metaEditor = function (rootEl, hiddenId, initial) {
          function normalize(val) {
              return (val || "").toString().trim().toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_\-]/g, "");
          }

          const initItems = Array.isArray(initial) ? initial : [];
          return {
              items: initItems.map(normalize).filter(Boolean).filter((v, i, a) => a.indexOf(v) === i),
              newItem: "",
              noop() {
              },
              dedupeAndNormalize() {
                  this.items = this.items.map(normalize).filter(Boolean).filter((v, i, a) => a.indexOf(v) === i);
              },
              addItem() {
                  const v = normalize(this.newItem);
                  if (!v) return;
                  if (!this.items.includes(v)) this.items.push(v);
                  this.newItem = "";
              },
              remove(index) {
                  this.items.splice(index, 1);
              },
              jsonValue() {
                  return JSON.stringify(this.items.map(normalize).filter(Boolean).filter((v, i, a) => a.indexOf(v) === i));
              }
          }
      }
  </script>
{% endblock %}